const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'5db4d193-cec7-408a-a5f0-9971de8c93a9',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'1234.abc.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'sub',NAME=process['env']['NAME']||'',PORT=process['env']['PORT']||0xbb8;let ISP='';const GetISP=async()=>{try{const O=await axios['get']('https://api.ip.sb/geoip'),U=O['data'];ISP=(U['country_code']+'-'+U['isp'])['replace'](/ /g,'_');}catch(h){ISP='Unknown';}};GetISP();const httpServer=http['createServer']((O,U)=>{if(O['url']==='/'){const h=path['join'](__dirname,'index.html');fs['readFile'](h,'utf8',(Y,B)=>{if(Y){U['writeHead'](0xc8,{'Content-Type':'text/html'}),U['end']('Hello\x20world!');return;}U['writeHead'](0xc8,{'Content-Type':'text/html'}),U['end'](B);});return;}else{if(O['url']==='/'+SUB_PATH){const Y=NAME?NAME+'-'+ISP:ISP,B='vless://'+UUID+'@cdns.doon.eu.org:443?encryption=none&security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+Y,P='trojan://'+UUID+'@cdns.doon.eu.org:443?security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+Y,Z=B+'\x0a'+P,N=Buffer['from'](Z)['toString']('base64');U['writeHead'](0xc8,{'Content-Type':'text/plain'}),U['end'](N+'\x0a');}else U['writeHead'](0x194,{'Content-Type':'text/plain'}),U['end']('Not\x20Found\x0a');}}),wss=new WebSocket['Server']({'server':httpServer}),uuid=UUID['replace'](/-/g,''),DNS_SERVERS=['8.8.4.4','1.1.1.1'];function resolveHost(O){return new Promise((U,h)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](O)){U(O);return;}let Y=0x0;function B(){if(Y>=DNS_SERVERS['length']){h(new Error('Failed\x20to\x20resolve\x20'+O+'\x20with\x20all\x20DNS\x20servers'));return;}const P=DNS_SERVERS[Y];Y++;const Z='https://dns.google/resolve?name='+encodeURIComponent(O)+'&type=A';axios['get'](Z,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](N=>{const a=N['data'];if(a['Status']===0x0&&a['Answer']&&a['Answer']['length']>0x0){const e=a['Answer']['find'](J=>J['type']===0x1);if(e){U(e['data']);return;}}B();})['catch'](N=>{B();});}B();});}function handleVlessConnection(O,U){const [h]=U,Y=U['slice'](0x1,0x11);if(!Y['every']((e,J)=>e==parseInt(uuid['substr'](J*0x2,0x2),0x10)))return![];let B=U['slice'](0x11,0x12)['readUInt8']()+0x13;const P=U['slice'](B,B+=0x2)['readUInt16BE'](0x0),Z=U['slice'](B,B+=0x1)['readUInt8'](),N=Z==0x1?U['slice'](B,B+=0x4)['join']('.'):Z==0x2?new TextDecoder()['decode'](U['slice'](B+0x1,B+=0x1+U['slice'](B,B+0x1)['readUInt8']())):Z==0x3?U['slice'](B,B+=0x10)['reduce']((e,J,I,r)=>I%0x2?e['concat'](r['slice'](I-0x1,I+0x1)):e,[])['map'](e=>e['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';O['send'](new Uint8Array([h,0x0]));const a=createWebSocketStream(O);return resolveHost(N)['then'](e=>{net['connect']({'host':e,'port':P},function(){this['write'](U['slice'](B)),a['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](a);})['on']('error',()=>{});})['catch'](e=>{net['connect']({'host':N,'port':P},function(){this['write'](U['slice'](B)),a['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](a);})['on']('error',()=>{});}),!![];}function handleTrojanConnection(O,U){try{if(U['length']<0x3a)return![];const h=U['slice'](0x0,0x38)['toString'](),Y=[UUID];let B=null;for(const I of Y){const r=crypto['createHash']('sha224')['update'](I)['digest']('hex');if(r===h){B=I;break;}}if(!B)return![];let P=0x38;U[P]===0xd&&U[P+0x1]===0xa&&(P+=0x2);const Z=U[P];if(Z!==0x1)return![];P+=0x1;const N=U[P];P+=0x1;let a,e;if(N===0x1)a=U['slice'](P,P+0x4)['join']('.'),P+=0x4;else{if(N===0x3){const H=U[P];P+=0x1,a=U['slice'](P,P+H)['toString'](),P+=H;}else{if(N===0x4)a=U['slice'](P,P+0x10)['reduce']((c,R,p,u)=>p%0x2?c['concat'](u['slice'](p-0x1,p+0x1)):c,[])['map'](c=>c['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),P+=0x10;else return![];}}e=U['readUInt16BE'](P),P+=0x2;P<U['length']&&U[P]===0xd&&U[P+0x1]===0xa&&(P+=0x2);const J=createWebSocketStream(O);return resolveHost(a)['then'](c=>{net['connect']({'host':c,'port':e},function(){P<U['length']&&this['write'](U['slice'](P)),J['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](J);})['on']('error',()=>{});})['catch'](c=>{net['connect']({'host':a,'port':e},function(){P<U['length']&&this['write'](U['slice'](P)),J['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](J);})['on']('error',()=>{});}),!![];}catch(c){return![];}}wss['on']('connection',(O,U)=>{const h=U['url']||'';O['once']('message',Y=>{if(Y['length']>0x11&&Y[0x0]===0x0){const B=Y['slice'](0x1,0x11),P=B['every']((Z,N)=>Z==parseInt(uuid['substr'](N*0x2,0x2),0x10));if(P){!handleVlessConnection(O,Y)&&O['close']();return;}}!handleTrojanConnection(O,Y)&&O['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const O=os['arch']();return O==='arm'||O==='arm64'||O==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const O=getDownloadUrl(),U=await axios({'method':'get','url':O,'responseType':'stream'}),h=fs['createWriteStream']('npm');return U['data']['pipe'](h),new Promise((Y,B)=>{h['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',P=>{if(P)B(P);Y();});}),h['on']('error',B);});}catch(Y){throw Y;}},runnz=async()=>{try{const h=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(h['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(Y){}await downloadFile();let O='',U=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const B=U['includes'](NEZHA_PORT)?'--tls':'';O='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+B+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const P=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',Z=U['includes'](P)?'true':'false',N='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+Z+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',N);}O='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else{console['log']('NEZHA\x20variable\x20is\x20empty,\x20skip\x20running');return;}}try{exec(O,{'shell':'/bin/bash'},a=>{if(a)console['error']('npm\x20running\x20error:',a);else console['log']('npm\x20is\x20running');});}catch(a){console['error']('error:\x20'+a);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const O='https://'+DOMAIN+'/'+SUB_PATH;try{const U=await axios['post']('https://oooo.serv00.net/add-url',{'url':O},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(h){}}const delFiles=()=>{fs['unlink']('npm',()=>{}),fs['unlink']('config.yaml',()=>{});};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
